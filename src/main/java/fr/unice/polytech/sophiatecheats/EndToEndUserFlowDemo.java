package fr.unice.polytech.sophiatecheats;

import fr.unice.polytech.sophiatecheats.application.dto.order.ConfirmOrderRequest;
import fr.unice.polytech.sophiatecheats.application.dto.order.ConfirmOrderResponse;
import fr.unice.polytech.sophiatecheats.application.dto.user.BrowseRestaurantsRequest;
import fr.unice.polytech.sophiatecheats.application.dto.user.BrowseRestaurantsResponse;
import fr.unice.polytech.sophiatecheats.application.dto.user.AddDishToCartRequest;
import fr.unice.polytech.sophiatecheats.application.dto.user.AddDishToCartResponse;
import fr.unice.polytech.sophiatecheats.application.dto.user.PlaceOrderRequest;
import fr.unice.polytech.sophiatecheats.application.dto.user.PlaceOrderResponse;
import fr.unice.polytech.sophiatecheats.application.usecases.cart.AddDishToCartUseCase;
import fr.unice.polytech.sophiatecheats.application.usecases.cart.GetCartUseCase;
import fr.unice.polytech.sophiatecheats.application.usecases.order.ConfirmOrderUseCase;
import fr.unice.polytech.sophiatecheats.application.usecases.user.BrowseRestaurantsUseCase;
import fr.unice.polytech.sophiatecheats.application.usecases.user.order.PlaceOrderUseCase;
import fr.unice.polytech.sophiatecheats.domain.entities.restaurant.Dish;
import fr.unice.polytech.sophiatecheats.domain.entities.restaurant.Restaurant;
import fr.unice.polytech.sophiatecheats.domain.entities.user.User;
import fr.unice.polytech.sophiatecheats.domain.enums.DishCategory;
import fr.unice.polytech.sophiatecheats.domain.enums.PaymentMethod;
import fr.unice.polytech.sophiatecheats.domain.repositories.RestaurantRepository;
import fr.unice.polytech.sophiatecheats.domain.repositories.UserRepository;
import fr.unice.polytech.sophiatecheats.infrastructure.config.ApplicationConfig;

import java.math.BigDecimal;
import java.util.UUID;

/**
 * D√©monstration compl√®te du flux utilisateur de bout en bout dans SophiaTechEats.
 * Montre toutes les √©tapes qu'un utilisateur peut r√©aliser :
 * navigation ‚Üí ajout au panier ‚Üí commande ‚Üí paiement ‚Üí confirmation
 */
public class EndToEndUserFlowDemo {

    public static void main(String[] args) {
        System.out.println("=== D√âMONSTRATION FLUX UTILISATEUR COMPLET - SophiaTechEats ===\n");

        // Configuration de l'application
        ApplicationConfig config = new ApplicationConfig();

        // === √âTAPE 0: PR√âPARATION DES DONN√âES ===
        System.out.println("üîß PR√âPARATION: Configuration des donn√©es de test...");
        setupTestData(config);

        // === √âTAPE 1: PARCOURIR LES RESTAURANTS ===
        System.out.println("\nüìã √âTAPE 1: L'utilisateur parcourt les restaurants disponibles");
        browseRestaurants(config);

        // === √âTAPE 2: AJOUTER DES PLATS AU PANIER ===
        System.out.println("\nüõí √âTAPE 2: L'utilisateur ajoute des plats √† son panier");
        addDishesToCart(config);

        // === √âTAPE 3: CONSULTER LE PANIER ===
        System.out.println("\nüëÄ √âTAPE 3: L'utilisateur consulte son panier");
        viewCart(config);

        // === √âTAPE 4: PASSER COMMANDE AVEC PAIEMENT PAR CR√âDIT √âTUDIANT ===
        System.out.println("\nüí≥ √âTAPE 4: L'utilisateur passe commande et paie avec son cr√©dit √©tudiant");
        String orderId = placeOrderWithStudentCredit(config);

        // === √âTAPE 5: CONFIRMER LA COMMANDE ===
        System.out.println("\n‚úÖ √âTAPE 5: La commande est confirm√©e (simulation restaurant)");
        confirmOrder(config, orderId);

        System.out.println("\nüéâ === FLUX COMPLET TERMIN√â AVEC SUCC√àS ===");
        System.out.println("L'utilisateur a pu r√©aliser un parcours complet de A √† Z !");
    }

    private static void setupTestData(ApplicationConfig config) {
        UserRepository userRepo = config.getInstance(UserRepository.class);
        RestaurantRepository restaurantRepo = config.getInstance(RestaurantRepository.class);

        // Cr√©er un utilisateur avec du cr√©dit
        User student = new User("etudiant.demo@unice.fr", "Marie Dupont");
        student.setStudentCredit(BigDecimal.valueOf(50.00));
        userRepo.save(student);

        // Cr√©er un restaurant avec des plats
        Restaurant pizzeria = new Restaurant("Pizzeria SophiaTech", "Campus SophiaTech, B√¢timent Forum");
        Dish pizza = Dish.builder()
            .id(UUID.randomUUID())
            .name("Pizza Margherita")
            .description("Pizza classique avec tomate, mozzarella et basilic")
            .price(BigDecimal.valueOf(12.50))
            .category(DishCategory.MAIN_COURSE)
            .available(true)
            .build();
        Dish salade = Dish.builder()
            .id(UUID.randomUUID())
            .name("Salade C√©sar")
            .description("Salade fra√Æche avec poulet grill√© et parmesan")
            .price(BigDecimal.valueOf(9.00))
            .category(DishCategory.STARTER)
            .available(true)
            .build();
        Dish tiramisu = Dish.builder()
            .id(UUID.randomUUID())
            .name("Tiramisu")
            .description("Dessert italien traditionnel")
            .price(BigDecimal.valueOf(6.50))
            .category(DishCategory.DESSERT)
            .available(true)
            .build();
        pizzeria.addDish(pizza);
        pizzeria.addDish(salade);
        pizzeria.addDish(tiramisu);
        restaurantRepo.save(pizzeria);

        System.out.println("‚úì Utilisateur cr√©√©: " + student.getName() + " (Cr√©dit: " + student.getStudentCredit() + "‚Ç¨)");
        System.out.println("‚úì Restaurant cr√©√©: " + pizzeria.getName() + " avec " + pizzeria.getMenu().size() + " plats");
    }

    private static void browseRestaurants(ApplicationConfig config) {
        BrowseRestaurantsUseCase browseUseCase = config.getInstance(BrowseRestaurantsUseCase.class);

        BrowseRestaurantsRequest request = new BrowseRestaurantsRequest(
            null, // cuisineType
            null, // availabilityFilter
            null, // dietType
            null, // minPrice
            null, // maxPrice
            null  // restaurantType
        );
        BrowseRestaurantsResponse response = browseUseCase.execute(request);

        System.out.println("üìç Restaurants disponibles: " + response.restaurants().size());
        response.restaurants().forEach(restaurant -> {
            System.out.println("  ‚Ä¢ " + restaurant.name() + " - " + restaurant.address());
            System.out.println("    üí∞ Plats disponibles: " + restaurant.dishes().size());
            restaurant.dishes().forEach(dish -> {
                System.out.println("      - " + dish.name() + " (" + dish.price() + "‚Ç¨) - " + dish.description());
            });
        });
    }

    private static void addDishesToCart(ApplicationConfig config) {
        UserRepository userRepo = config.getInstance(UserRepository.class);
        RestaurantRepository restaurantRepo = config.getInstance(RestaurantRepository.class);
        AddDishToCartUseCase addToCartUseCase = config.getInstance(AddDishToCartUseCase.class);

        User user = userRepo.findAll().get(0);
        Restaurant restaurant = restaurantRepo.findAll().get(0);

        // Ajouter pizza au panier
        Dish pizza = restaurant.getMenu().stream()
            .filter(dish -> dish.getName().contains("Pizza"))
            .findFirst().orElseThrow();

        AddDishToCartRequest pizzaRequest = new AddDishToCartRequest(user.getId(), pizza.getId(), 1);
        AddDishToCartResponse pizzaResponse = addToCartUseCase.execute(pizzaRequest);

        System.out.println("üçï Ajout√© au panier: " + pizza.getName() + " x1");
        System.out.println("   üí∞ Sous-total: " + pizzaResponse.totalAmount() + "‚Ç¨");

        // Ajouter salade au panier
        Dish salade = restaurant.getMenu().stream()
            .filter(dish -> dish.getName().contains("Salade"))
            .findFirst().orElseThrow();

        AddDishToCartRequest saladeRequest = new AddDishToCartRequest(user.getId(), salade.getId(), 1);
        AddDishToCartResponse saladeResponse = addToCartUseCase.execute(saladeRequest);

        System.out.println("ü•ó Ajout√© au panier: " + salade.getName() + " x1");
        System.out.println("   üí∞ Sous-total: " + saladeResponse.totalAmount() + "‚Ç¨");
    }

    private static void viewCart(ApplicationConfig config) {
        UserRepository userRepo = config.getInstance(UserRepository.class);
        GetCartUseCase getCartUseCase = config.getInstance(GetCartUseCase.class);

        User user = userRepo.findAll().get(0);

        try {
            var cartResponse = getCartUseCase.execute(user.getId());
            System.out.println("üõí Contenu du panier:");
            System.out.println("   üì¶ Articles: " + cartResponse.totalItems());
            System.out.println("   üí∞ Total: " + cartResponse.totalAmount() + "‚Ç¨");

            cartResponse.items().forEach(item -> {
                System.out.println("     ‚Ä¢ " + item.dishName() + " x" + item.quantity() +
                                 " = " + item.subtotal() + "‚Ç¨");
            });
        } catch (Exception e) {
            System.out.println("‚ùó Impossible de r√©cup√©rer le panier: " + e.getMessage());
        }
    }

    private static String placeOrderWithStudentCredit(ApplicationConfig config) {
        UserRepository userRepo = config.getInstance(UserRepository.class);
        RestaurantRepository restaurantRepo = config.getInstance(RestaurantRepository.class);
        PlaceOrderUseCase placeOrderUseCase = config.getInstance(PlaceOrderUseCase.class);

        User user = userRepo.findAll().get(0);
        Restaurant restaurant = restaurantRepo.findAll().get(0);

        System.out.println("üí≥ Cr√©dit disponible avant commande: " + user.getStudentCredit() + "‚Ç¨");

        PlaceOrderRequest orderRequest = new PlaceOrderRequest(
            user.getId(),
            restaurant.getId(),
            PaymentMethod.STUDENT_CREDIT
        );

        PlaceOrderResponse orderResponse = placeOrderUseCase.execute(orderRequest);

        System.out.println("üéØ Commande cr√©√©e avec succ√®s!");
        System.out.println("   üìã ID commande: " + orderResponse.orderId());
        System.out.println("   üë§ Client: " + orderResponse.customerName());
        System.out.println("   üè™ Restaurant: " + orderResponse.restaurantName());
        System.out.println("   üí∞ Montant: " + orderResponse.totalAmount() + "‚Ç¨");
        System.out.println("   üí≥ Paiement: " + orderResponse.paymentMethod());
        System.out.println("   üìä Statut: " + orderResponse.status());
        System.out.println("   üïê Command√© le: " + orderResponse.orderDateTime());

        // V√©rifier le cr√©dit restant
        User updatedUser = userRepo.findById(user.getId()).orElseThrow();
        System.out.println("üí≥ Cr√©dit restant: " + updatedUser.getStudentCredit() + "‚Ç¨");

        return orderResponse.orderId();
    }

    private static void confirmOrder(ApplicationConfig config, String orderId) {
        ConfirmOrderUseCase confirmUseCase = config.getInstance(ConfirmOrderUseCase.class);

        ConfirmOrderRequest confirmRequest = new ConfirmOrderRequest(orderId);
        ConfirmOrderResponse confirmResponse = confirmUseCase.execute(confirmRequest);

        System.out.println("‚úÖ Commande confirm√©e!");
        System.out.println("   üìã ID commande: " + confirmResponse.orderId());
        System.out.println("   üë§ Client: " + confirmResponse.customerName());
        System.out.println("   üè™ Restaurant: " + confirmResponse.restaurantName());
        System.out.println("   üí∞ Montant total: " + confirmResponse.totalAmount() + "‚Ç¨");
        System.out.println("   üìä Statut: " + confirmResponse.status());
        System.out.println("   ‚úÖ Confirm√©e le: " + confirmResponse.confirmedAt());
        System.out.println("   üöö Livraison estim√©e: " + confirmResponse.estimatedDeliveryTime());

        System.out.println("\nüçï Votre commande sera livr√©e dans environ 30 minutes!");
    }
}
